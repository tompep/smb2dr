<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=540px, initial-scale=1.0">
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

        <title>SMB2DR</title>
        <meta name="description" content="Super Mario Brothers 2 Door Randomizer">
        <meta name="author" content="tom.p">

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

        <link rel="stylesheet" href="css/styles.css">

        <script
              src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
        <script>!window.jQuery && document.write('<script src="jquery-3.3.1.min.js"><\/script>')</script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.4/seedrandom.min.js"> </script>
    </head>
    <body class='hide_me'>
        <div class='center'>
            <img src="css/titletop2.png"></img>
            </br>
            </br>
            <div class="pad5">
                <a id='start_summary'>About</a>
                <a id='start_randomizer'>Randomizer</a>
                <a id='start_map_viewer'>Maps</a>
                <a id='start_character_viewer'>Characters</a>
                <a id='start_changelog'>Change Log</a>
            </div>
            </br>

            <div id="summary" class="main_item">
                <div id="summarytext" class="summarytext">Failed to grab README.md                </div>
                <div>
                <img src="css/smb2-output-5.png"> </img>
                <img src="css/smb2-output-0.png"> </img>
                <img src="css/smb2-output-1.png"> </img>
                <img src="css/smb2-output-2.png"> </img>
                <img src="css/smb2-output-3.png"> </img>
                <img src="css/smb2-output-4.png"> </img>
                </div>
                <div>
                New items are available in subspace or blocks!
                <img src='css/chr000.png'></img>
                </div>
                <div>
                From left to right:
                <div>
                    <div>Power Throw - Charge Crouch then throw items with B</div>
                    <div>Power Charge - Decreases charge time</div>
                    <div>Power Walk - Allows retaining charge while moving</div>
                    <div>Store Item - Store an item with Up + B</div>
                    <div>Life Vest - Survive a fall with one damage taken</div>
                    <div>Electric Immunity- Immune to Sparks</div>
                    <div>Fire Immunity - Immune to fire sources</div>
                    <div>Magic Mirror - Detect secret items</div>
                    <div>All-Terrain Boots - Immune to sand, ice and conveyor belts</div>
                    <div>Jump Boots - Taller jump</div>
                    <div>Float Boots - Hold A to fall gently</div>
                    <div>Master Key - Open any locked door</div>
                    <div>Toss Jump - Double Jump while holding an item</div>
                    <div>Unimplemented - A Map of the world/game </div>
                    <div>Unimplemented - Power-up stats </div>
                    <div>Unimplemented - Luck up, immune to curses </div>
                </div>
                <div>
                    <div>Fire Flower - Throw 2 fireballs</div>
                    <div>Egg Thrower - Toss single straight egg</div>
                    <div>Bomb Thrower - Throw bombs</div>
                    <div>Fryguy Buddy - Throw jumping flames</div>
                    <div>Phanto Buddy - Throw friendly Phanto</div>
                </div>
                Other items include: Continues, Unlocks, and common items
                </div>
            </div>

            <div id="changelog" class="main_item">
                <div id="changelogtext" class="summarytext">Failed to grab CHANGELOG.md                </div>
            </div>
                
            <div id="fileupload" class="main_item">
                <label><input type="file" class="input" id="files" name="file"/></label>
            </div>

            <div id="randomizer_body" class="main_item">
                <label style="display: block">Seed <input type="text" class="input" id="seed"/></label>
                <button id="random_seed" onclick="$('#seed').val(rand_seed(Math.seedrandom()))">Random Seed </button>
                <br/>
                <br/>
                <div class='option_div'>
                    <div id='preset_images'></div>
                    <select id="preset_game" class="a_preset" oninput="reload_options(presets[this.value].config, '#randomizer_body')">
                        <option value='-1'>Select Preset</option>
                    </select>
                    <button onclick="$('#option_load').trigger('click')">Load Preset </button>
                    <div class="hide_me">
                        <input type="file" id="option_load" class="hide_me" name="files[]"
                            onchange="load_options(event.target.files, '#randomizer_body')"></input>
                    </div>
                    <button onclick="save_options('#randomizer_body', 'smb2dr_options.json')">Save Preset </button>
                </div>
                <br/>
                <div class="" id="randomizer">
                </div>
            </div>

            
            <div class="main_item" id="map_viewer">
                In Progress
                <br/>
                World Select
                <form class='option_div'>
                    World
                    <input id="world" type="number" class="level_read" min="0" max="6" value="0"/>
                    Level
                    <input id="level" type="number" class="level_read" min="0" max="2" value="0"/>
                    Room
                    <input id="room" type="number" class="level_read" min="0" max="9" value="0"/>
                </form>
                Force Info
                <form class='option_div'>
                    Orientation
                    <input id="vert" type="number" class="level_read" min="0" max="1" value="0"/>
                    Pal A
                    <input id="pala" type="number" class="level_read" min="-1" max="7" value="-1"/>
                    Pal B
                    <input id="palb" type="number" class="level_read" min="-1" max="3" value="-1"/>
                    <br/>
                    Render World
                    <input id="unk3" type="number" class="level_read" min="-1" max="7" value="-1"/>
                    Render BX/CX
                    <input id="unk4" type="number" class="level_read" min="-1" max="3" value="-1"/>
                    Object Steps 
                    <input id="steps" type="number" class="level_read" min="-1" max="255" value="-1"/>
                    Render Sky
                    <input id="sky_on" type="checkbox" class="level_read" checked/>
                </form>
                <div class="map_frame">
                    <canvas id="myCanvas" width="256" height="256" style="border:1px solid #000000;">
                    </canvas>
                </div>
                <button id="writeJSON"> Output To JSON </button>
                <button id="readJSON"> Input From JSON </button>
                <div>
                <textarea id="info_dump" class='log'>
                </textarea>
                </div>
                Auditing
                <form class='option_div'>
                Audit Enemy
                <select id="a_enemy" class="level_audit">
                    <option value='-1'>Select Enemy</option>
                </select>
                Audit Object
                <select id="a_object" class="level_audit">
                    <option value='-1'>Select Object</option>
                </select>
                Audit Tile
                <select id="a_tiles" class="level_audit">
                    <option value='-1'>Select Tile</option>
                </select>
                </form>
                <button id="auditByRoom"> By Room </button>
                <button id="auditByLevel">  By Level </button>
                <button id="auditByWorld"> By World </button>
                <button id="auditByGame">  By Game </button>
            </div>
            <div class="main_item" id="char_viewer">
                In Progress
                <div class="option_div"> 
                Character
                <input id="a_character" type="number" class="char_read" min="0" max="3" value="0"/>
                Frame
                <input id="a_frame" type="number" class="char_read" min="-1" max="10" value="0"/>
                <label>
                <input id="a_size" type="checkbox" class="char_read"/>
                Small
                </label>
                <select id="a_char_pal" class="level_audit hide_me">
                    <option value='-1'>Select Palette</option>
                </select>
                <form id="palette_character"></form>
                <button onclick="$('#char_sheet_load').trigger('click')">Load Sheet</button>
                <div class="hide_me">
                    <label><input type="file" class="input" id="char_sheet_load" name="file"/></label>
                </div>
                <button id='char_sheet_save'>Save Sheet</button>
                <button id="writeJSON_char" class='hide_me'> Random Player Palette </button>
                </div>
                <div id="char_sprites">No sprites read.</div>
                <div id="char_stats"></div>
                <button id="writeJSON_char"> Output To JSON </button>
                <button id="readJSON_char"> Input From JSON </button>
                <div>
                <textarea id="info_dump_char" class='log'>
                </textarea>
                </div>
            </div>
            <div class="main_item" id="sprite_viewer">
                <div class="map_frame">
                </div>
            </div>


        </div>
        <pre id="log" class="log">>___</pre>


        <script src="js/bind_console_log.js"></script>
        <script src="js/patch_ips.js"></script>
        <script src="js/graphics.js"></script>
        <script src="js/metadata_obj_tiles.js"></script>
        <script src="js/render.js"></script>
        <script src="js/characters.js"></script>
        <script src="js/levels.js"></script>
        <script src="js/lt_browser.js"></script>
        <script src="js/randomizer_vania.js"></script>
        <script src="js/randomizer.js"></script>
        <script src="js/main_ui.js"></script>
        <script>
$('#char_sheet_load').on('input', handleSpriteSelect)
$('#char_sheet_save').on('click', outputSpriteSelect)
$('.char_read').on('input', show_character)

$.ajax({contentType: "json",
        url: "character_config.json",
        success: function(result){
            console.log(this.url + ' grabbed')
            $("#char_stats").text()
            $("#char_stats").append(...handle_options(result))
            $('#char_stats input[type=number]').on('focusout', number_cap)
            $('#char_stats input').on('change', write_to_character)
            $('#char_stats select').on('change', write_to_character)
            $("#palette_character .nespalette_select").on('change', show_character)
            $('#palette_character select').on('change', write_to_character)
}});

console.log('Document ready...')
var oReq = new XMLHttpRequest();
oReq.open("GET", "patch/smb2-patch.ips", true);
oReq.responseType = "arraybuffer";
oReq.onload = function(oEvent) {
    var arrayBuffer = oReq.response;
    currentPatch = new Uint8Array(arrayBuffer);
    console.log('Patch grabbed', currentPatch.length)
}
oReq.send();

var oReq_A = new XMLHttpRequest();
oReq_A.open("GET", "patch/smb2-patch-reva.ips", true);
oReq_A.responseType = "arraybuffer";
oReq_A.onload = function(oEvent) {
    var arrayBuffer = oReq_A.response;
    currentPatch_A = new Uint8Array(arrayBuffer);
    console.log('Patch smb2 REVA grabbed length:', currentPatch_A.length)
}
oReq_A.send();

for (var i = 0; i < 9; i++){
    $.ajax({contentType: "text",
            url: "patch/smb2.nes." + i.toString() + ".nl",
            success: function(result){
                console.log(this.url + ' grabbed')
                mem_locs = Object.assign({}, mem_locs, 
                        setupLabels(result, parseInt(this.url.split('.')[2])))
    }});
}

var preset_names = ['Sample Config.json', 'Adventure.json']

$.when(...preset_names.map(x => 
    $.ajax({contentType: "json",
            url: "presets/" + x,
            indexValue: i,
            success: function(result){
                console.log(this.url + ' grabbed')
                var my_name = this.url.replace('.json', '').replace('presets/', '')
                presets.push({'name': my_name, 'config': result})
            }
        }
))).done(function(){
    console.log('dimmadone', presets)
    while (presets.length != preset_names.length){}
    for(var i in presets)
        $('#preset_game').append('<option value="' + i + '">' + presets[i].name + '</option>')
})

$.ajax({contentType: "text",
        url: "README.md",
        success: function(result){
            console.log(this.url + ' grabbed')
            $("#summarytext").text()
            $("#summarytext").text(result)
}});

$.ajax({contentType: "text",
        url: "CHANGELOG.md",
        success: function(result){
            console.log(this.url + ' grabbed')
            $("#changelogtext").text()
            $("#changelogtext").text(result)
}});


$.ajax({contentType: "json",
        url: "smb2dr_config.json",
        success: function(result){
            console.log(this.url + ' grabbed')
            $("#randomizer").text()
            $("#randomizer").append(...handle_options(result))
            var start_button = $('<button id="manip">')
            start_button.click(randomize_rom);
            start_button.text('Randomize ROM');
            console.log(start_button)

            $("#randomizer").append(start_button)
            $('#randomizer input[type=number]').on('focusout', number_cap)
}});


$('#seed').keypress(function (evt){
    if (chars.includes(String.fromCharCode(evt.which).toUpperCase())) {}
    else if (!chars.includes(String.fromCharCode(evt.which))){
        evt.preventDefault();
    }
});

if (Math.seedrandom)
    Math.seedrandom((new Date()).toUTCString().split(' ').slice(0, 4).join(' '))

$('#seed').val(rand_seed());
$('#seed').attr('maxlength', 10);

$('#a_enemy').append(EnemyIds.map((x, y) => 
    $('<option value="' + y + '">' + x.replace('Enemy_', '') + '</option>')));
$('#a_tiles').append(BackgroundTileIds.map((x, y) => 
    $('<option value="' + y + '">' + x.replace('Tile_', '') + '</option>')));
$('#a_object').append(MapObjectIds.map((x, y) => 
    $('<option value="' + y + '">' + x + '</option>')));
$('#a_object').append(MapObjectIdsExtendable.slice(3).map((x, y) => 
    $('<option value="' + (y * 0x10 + 0x30) + '">' + x + '</option>')));

var select_color = $('<select class="nespalette_select"></select>')
select_color.on('input', function(evt){
    var x = this.value
    var color_string = NES_palette[x].toString()
    color_string = color_string.slice(1, color_string.length)
    color_string = 'rgba(' + NES_palette[x].toString() + ')'
    this.style.backgroundColor = color_string
})
for (var x in NES_palette){
    var color_string = NES_palette[x].toString()
    color_string = color_string.slice(1, color_string.length)
    color_string = 'rgba(' + NES_palette[x].toString() + ')'
    var color_option = $('<option style="background-color: '+ color_string +'" val="'+ x +'" > </option>')
    color_option.text(x)
    select_color.append(color_option)
}

$("#palette_character").append(select_color.clone(true))
$("#palette_character").append(select_color.clone(true))
$("#palette_character").append(select_color.clone(true))
$("#palette_character").append(select_color.clone(true))

$('input[type=number]').on('focusout', number_cap)

$('#files').on('input', handleFileSelect);
$('.level_read').on('input', show_level);
$('#writeJSON').click(writeJSON);
$('#readJSON').click(readJSON);



var canvas = document.getElementById("myCanvas")
var ctx = canvas.getContext("2d");
ctx.fillStyle='white'
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.stroke()

window.onload = function(){
    $('body').fadeIn()
    $('.main_item').fadeOut(0)
    $('#summary').fadeIn()
}

        </script>
    </body>
</html>
