<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=540px, initial-scale=1.0">
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

        <title>SMB2DR</title>
        <meta name="description" content="Super Mario Brothers 2 Door Randomizer">
        <meta name="author" content="tom.p">

        <link rel="stylesheet" href="css/styles.css">

        <script
              src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
        <script>!window.jQuery && document.write('<script src="jquery-3.3.1.min.js"><\/script>')</script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.4/seedrandom.min.js"> </script>
    </head>
    <body>
        <div id='intro'>
        <img src="css/animatedwow.png"></img>
        </div>
        <div id='center' class='center no_pixel hide_me'>
            <img src="css/titletop2.png"></img>
            </br>
            </br>
            <div class="option_block no_pixel" id="links">
            Live Page: <a class="no_pixel" target='_blank' href="https://smb2randomizer.github.io/smb2dr/">https://smb2randomizer.github.io/smb2dr/</a>
            </br>
            Live Src: <a class="no_pixel" target='_blank' href="https://github.com/smb2randomizer">https://github.com/smb2randomizer/</a>
            </br>
            </div>
            </br>
            <div id="top_nav" class="pad5">
                <a class='button' id='start_summary'>About</a>
                <a class='button' id='start_randomizer'>Randomizer</a>
                <a class='button' id='start_map_viewer'>Maps</a>
                <a class='button' id='start_character_viewer'>Characters</a>
                <a class='button' id='start_changelog'>Change Log</a>
            </div>
            </br>

            <div id="summary" class="main_item">
                <div id="summarytext" class="summarytext no_pixel">Failed to grab README.md                </div>
                <div>
                <img src="css/smb2-output-5.png"> </img>
                <img src="css/smb2-output-0.png"> </img>
                <img src="css/smb2-output-1.png"> </img>
                <img src="css/smb2-output-2.png"> </img>
                <img src="css/smb2-output-3.png"> </img>
                <img src="css/smb2-output-4.png"> </img>
                </div>
                <div>
                New items are available in subspace or blocks!
                </div>
                <img src='css/chr000.png'></img>
                <div>
                <div>
                From left to right:
                </div>
                <div>
                    <div>Power Throw - Charge Crouch then throw items with B</div>
                    <div>Power Charge - Decreases charge time</div>
                    <div>Power Walk - Allows retaining charge while moving</div>
                    <div>Store Item - Store an item with Up + B</div>
                    <div>Life Vest - Survive a fall with one damage taken</div>
                    <div>Electric Immunity- Immune to Sparks</div>
                    <div>Fire Immunity - Immune to fire sources</div>
                    <div>Magic Mirror - Detect secret items</div>
                    <div>All-Terrain Boots - Immune to sand, ice and conveyor belts</div>
                    <div>Jump Boots - Taller jump</div>
                    <div>Float Boots - Hold A to fall gently</div>
                    <div>Master Key - Open any locked door</div>
                    <div>Toss Jump - Double Jump while holding an item</div>
                    <div>Unimplemented - A Map of the world/game </div>
                    <div>Unimplemented - Power-up stats </div>
                    <div>Unimplemented - Luck up, immune to curses </div>
                </div>
                <div>
                    <div>Fire Flower - Throw 2 fireballs</div>
                    <div>Egg Thrower - Toss single straight egg</div>
                    <div>Bomb Thrower - Throw bombs</div>
                    <div>Fryguy Buddy - Throw jumping flames</div>
                    <div>Phanto Buddy - Throw friendly Phanto</div>
                </div>
                Other items include: Continues, Unlocks, and common items
                </div>
            </div>

            <div id="changelog" class="main_item">
                <div id="changelogtext" class="summarytext no_pixel">Failed to grab CHANGELOG.md                </div>
            </div>
                
            <div id="fileupload" class="main_item option_block">
                <label>Input ROM File: </label>   
            </div>

            <div id="randomizer_body" class="main_item">
                <label style="display: block">Seed<input type="text" class="input" id="seed"/></label>
                <button id="random_seed" onclick="starting_seed()">Daily Seed </button>
                <button id="random_seed" onclick="$('#seed').val(rand_seed(Math.seedrandom()))">Random Seed </button>
                <br/>
                <br/>
                <div class='option_block'>
                    <div class='bold'>Preset Configurations</div>
                    <div id='preset_images'></div>
                    <select id="preset_game" class="a_preset" oninput="reload_options(presets[this.value].config, $('#randomizer'))">
                        <option value='-1'>Select Preset</option>
                    </select>
                    <button onclick="$('#option_load').trigger('click')">Load Preset </button>
                    <div class="hide_me">
                        <input type="file" id="option_load" accept=".json,.jsn" class="hide_me" name="files[]" multiple
                            onchange="load_options(event.target.files, $('#randomizer'))"></input>
                    </div>
                    <button onclick="save_options($('#randomizer'), 'smb2dr_options.json')">Save Preset </button>
                </div>
                <br/>
                <div class="" id="randomizer">
                </div>
            </div>

            
            <div class="main_item" id="map_viewer">
                In Progress
                <br/>
                World Select
                <form class='option_block'>
                    World
                    <input id="world" type="number" class="level_read" min="0" max="6" value="0"/>
                    Level
                    <input id="level" type="number" class="level_read" min="0" max="2" value="0"/>
                    Room
                    <input id="room" type="number" class="level_read" min="0" max="9" value="0"/>
                </form>
                Force Info
                <form class='option_block'>
                    Orientation
                    <input id="vert" type="number" class="level_read" min="0" max="1" value="0"/>
                    Pal A
                    <input id="pala" type="number" class="level_read" min="-1" max="7" value="-1"/>
                    Pal B
                    <input id="palb" type="number" class="level_read" min="-1" max="3" value="-1"/>
                    <br/>
                    Render World
                    <input id="unk3" type="number" class="level_read" min="-1" max="7" value="-1"/>
                    Render BX/CX
                    <input id="unk4" type="number" class="level_read" min="-1" max="3" value="-1"/>
                    <br/>
                    Object Steps 
                    <input id="steps" type="number" class="level_read" min="-1" max="255" value="-1"/>
                    Render Sky
                    <input id="sky_on" type="checkbox" class="level_read" checked/>
                </form>
                <div class="map_frame">
                    <canvas id="myCanvas" width="256" height="256" style="border:1px solid #000000;">
                    </canvas>
                </div>
                <button id="writeJSON"> Output To JSON </button>
                <button id="readJSON"> Input From JSON </button>
                <div>
                <textarea id="info_dump" class='log'>
                </textarea>
                </div>
                Auditing
                <form class='option_block'>
                Audit Enemy
                <select id="a_enemy" class="level_audit">
                    <option value='-1'>Select Enemy</option>
                </select>
                Audit Object
                <select id="a_object" class="level_audit">
                    <option value='-1'>Select Object</option>
                </select>
                Audit Tile
                <select id="a_tiles" class="level_audit">
                    <option value='-1'>Select Tile</option>
                </select>
                </form>
                <button id="auditByRoom"> By Room </button>
                <button id="auditByLevel">  By Level </button>
                <button id="auditByWorld"> By World </button>
                <button id="auditByGame">  By Game </button>
            </div>
            <div class="main_item" id="sprite_viewer">
                <div class="map_frame">
                </div>
            </div>


        </div>


        
        <script src="js/bind_console_log.js"> </script>
        <script src="js/memory.js"> </script>
        <script src="js/patch_ips.js"></script>
        <script src="js/graphics.js"></script>
        <script src="js/metadata_obj_tiles.js"></script>

        <script src="js/main_ui.js"></script>
        <script src="js/characters.js"></script>
        <script src="js/levels.js"></script>
        <script src="js/render.js"></script>
        <script src="js/lt_browser.js"></script>
        <script src="js/randomizer_vania.js"></script>
        <script src="js/randomizer.js"></script>
        <script>
// TODO: Look into bundling the above with some sort of toolchain build
var log_component = new html_logger('log_div')
log_component.rebind_console_log()

var char_component = new char_viewer('char_viewer')
$('#center').append(char_component.my_div)
console.log(char_component.my_div)

$('input[type=number]').on('focusout', number_cap)

var discord_page = 'https://discord.gg/z8CMDqg'
var d_link = $('<a target="_blank">')
d_link.attr('class', 'no_pixel')
d_link.attr('href', discord_page)
d_link.text(discord_page)
$('#links').append('Discord: ')
$('#links').append(d_link)
$('#links').append("</br>")
$('#links').append('Current page: ')
$('#links').append('<a class="no_pixel" target="_blank" href="">' + window.location.href + '</a>')

console.log('Document ready...')

function finish_page_setup(){
    var oReq = new XMLHttpRequest();
    oReq.open("GET", "patch/smb2-patch.ips", true);
    oReq.responseType = "arraybuffer";
    oReq.onload = function(oEvent) {
        var arrayBuffer = oReq.response;
        currentPatch = new Uint8Array(arrayBuffer);
        console.log('Patch grabbed', currentPatch.length)
    }
    oReq.send();

    var oReq_A = new XMLHttpRequest();
    oReq_A.open("GET", "patch/smb2-patch-reva.ips", true);
    oReq_A.responseType = "arraybuffer";
    oReq_A.onload = function(oEvent) {
        var arrayBuffer = oReq_A.response;
        currentPatch_A = new Uint8Array(arrayBuffer);
        console.log('Patch smb2 REVA grabbed length:', currentPatch_A.length)
    }
    oReq_A.send();

    $.ajax({contentType: "text",
            url: "patch/smb2.lst",
            success: function(result){
                console.log(this.url + ' grabbed')
                mem_locs = setupLabelsLst(result) 
    }});

    var preset_names = ['Short Level Randomizer.json', 'Full Level Randomizer.json',
    'Short Simple Door Randomizer.json', 'Long Simple Door Randomizer.json',
    'Short Open-world Door Randomizer.json', 'Long Open-world Door Randomizer.json',
    'Short Hub-world Door Randomizer.json', 'Long Hub-world Door Randomizer.json',
    'Open-world Rescue Mission.json']

    $.when(...preset_names.map((x, i) => 
        $.ajax({contentType: "json",
                url: "presets/" + x,
                indexValue: i,
                success: function(result){
                    console.log(this.url + ' grabbed', this.indexValue)
                    var my_name = this.url.replace('.json', '').replace('presets/', '')
                    var i = this.indexValue
                    presets[i] = ({'name': my_name, 'config': result})
                    $('#preset_game').append('<option value="' + i + '">' + presets[i].name + '</option>')
                },
                error: function(result){
                    console.log(this.url + ' not grabbed')
                }
            }
    )))

    var char_names = ['Mario.json', 'Luigi.json', 'Peach.json', 'Toad.json',
        'Imajin.json', 'Lina.json', 'Mama.json', 'Papa.json', 'Yoshi.json', 'Wario (WL3).json', 'DK.json', 'L-Block.json',
        'Bowser.json', 'Bowser Jr.json', 'Toadette.json', 'Dr. Mario.json', 'Pocket Bomberman.json',
        'Link.json', 'Simon.json', 'Sonic.json', 'ShyGuy.json', 'Mouser.json', 'Birdo.json', 'Luigi with a Gun.json']

    var queue_chars = []


    $.when(...char_names.map((x, i) => 
        $.ajax({contentType: "json",
                url: "preset-chars/" + x,
                indexValue: i,
                success: function(result){
                    console.log(this.url + ' grabbed')
                    var my_name = this.url.replace('.json', '').replace('preset-chars/', '')
                    queue_chars[this.indexValue] = ({'name': my_name, 'config': result})
                    var i = this.indexValue
                    char_component.preset_characters[i] = queue_chars[i]
                    var my_preset_list = char_component.preset_chars_div
                    my_preset_list.append('<option value="' + i + '">' + queue_chars[i].name + '</option>')
                },
                fail: function(result){
                    console.log(this.url + ' not grabbed')
                }
            }
    )))

    $.ajax({contentType: "text",
            url: "README.md",
            success: function(result){
                console.log(this.url + ' grabbed')
                $("#summarytext").text()
                $("#summarytext").text(result)
    }});

    $.ajax({contentType: "text",
            url: "CHANGELOG.md",
            success: function(result){
                console.log(this.url + ' grabbed')
                $("#changelogtext").text()
                $("#changelogtext").text(result)
    }});


    $('#a_enemy').append(EnemyIds.map((x, y) => 
        $('<option value="' + y + '">' + x.replace('Enemy_', '') + '</option>')));
    $('#a_tiles').append(BackgroundTileIds.map((x, y) => 
        $('<option value="' + y + '">' + x.replace('Tile_', '') + '</option>')));
    $('#a_object').append(MapObjectIds.map((x, y) => 
        $('<option value="' + y + '">' + x + '</option>')));
    $('#a_object').append(MapObjectIdsExtendable.slice(3).map((x, y) => 
        $('<option value="' + (y * 0x10 + 0x30) + '">' + x + '</option>')));


    $('input[type=number]').on('focusout', number_cap)

    var file_input = $('<input type="file" accept=".nes,.bin" class="input" onchange="handleFileSelect(event);"/>')
    $('#fileupload').append(file_input)

    $('.level_read').on('change', show_level);
    $('#writeJSON').click(writeJSON);
    $('#readJSON').click(readJSON);

    var canvas = document.getElementById("myCanvas")
    var ctx = canvas.getContext("2d");
    ctx.fillStyle='white'
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.stroke()

    console.log(window.location.hash)
    if ( !(window.location.hash && window.location.hash == '#nosprite')  )
        textify_everything(9999)
}

finish_page_setup()

window.onload = function(){

    $('#intro').fadeOut(0)
    $('#center').fadeIn(0)
    $('.main_item').fadeOut(0)
    $('#summary').fadeIn()
    $('body').append(log_component.log_div)
    window.scrollTo(0, 0);

}

        </script>
    </body>
</html>
